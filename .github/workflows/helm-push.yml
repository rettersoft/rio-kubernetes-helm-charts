name: Release Helm Charts
on:
  push:
    branches: [ ready-for-dev ]
permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Read version file
        id: read_version
        run: echo "VERSION=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install Helm & yq
        run: |
          curl -Lo helm.tar.gz https://get.helm.sh/helm-v3.11.3-linux-amd64.tar.gz && \
            tar zxvf helm.tar.gz linux-amd64/helm && mv linux-amd64/helm /usr/local/bin
          wget https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64 -O /usr/local/bin/yq && \
            chmod +x /usr/local/bin/yq

      - name: Bump all chart versions
        run: |
          export NEW_VERSION="${{ steps.read_version.outputs.VERSION }}"
          for chart in projectid3 console vault-manager; do
            yq eval -i '
              .version = strenv(NEW_VERSION) |
              .appVersion = strenv(NEW_VERSION)
            ' charts/rio-projects/$chart/Chart.yaml
          done

      - name: Commit version bump
        uses: EndBug/add-and-commit@v9
        with:
          add: 'charts/rio-projects/*/Chart.yaml'
          message: "chore: bump all charts to ${{ steps.read_version.outputs.VERSION }}"
          fetch: '--tags --force'

      - name: Login to Harbor
        run: |
          echo "${{ secrets.HARBOR_PASSWORD }}" \
            | helm registry login k8-harbor.retter.io \
              --username "${{ secrets.HARBOR_USERNAME }}" \
              --password-stdin

      - name: Package & push all charts
        run: |
          export NEW_VERSION="${{ steps.read_version.outputs.VERSION }}"
          for chart in projectid3 console vault-manager; do
            helm dependency update charts/rio-projects/$chart
            helm package charts/rio-projects/$chart \
              --version "$NEW_VERSION" --app-version "$NEW_VERSION"
            helm push charts/rio-projects/$chart/*.tgz \
              oci://k8-harbor.retter.io/rio-project-charts
          done
